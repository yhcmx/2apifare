export default {
  async fetch(request, env, ctx) {
    // 1. 定义 CORS 响应头 (解决客户端跨域报错问题)
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': '*',
    };

    // 2. 优先处理 OPTIONS 预检请求 (直接返回成功，不转发给谷歌)
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    const url = new URL(request.url);
    const path = url.pathname;
    
    // 路由映射表
    const routeMap = {
      '/oauth2': 'oauth2.googleapis.com',
      '/crm': 'cloudresourcemanager.googleapis.com',
      '/usage': 'serviceusage.googleapis.com',
      '/api': 'www.googleapis.com',
      '/code': 'cloudcode-pa.googleapis.com'
    };

    let targetHost = '';
    let matchedPrefix = '';

    for (const [prefix, host] of Object.entries(routeMap)) {
      if (path.startsWith(prefix)) {
        targetHost = host;
        matchedPrefix = prefix;
        break;
      }
    }

    if (!targetHost) {
      return new Response(JSON.stringify({ status: "Worker is active. Endpoint not found." }), {
        status: 200,
        headers: { ...corsHeaders, 'content-type': 'application/json' }
      });
    }

    // 3. 重写 URL
    url.hostname = targetHost;
    url.pathname = path.replace(matchedPrefix, ''); 

    // 4. 清洗请求头 (关键步骤：防止谷歌识别出这是 Cloudflare 代理)
    const newHeaders = new Headers(request.headers);

    // ✅ 修复1：设置正确的 Host 头（之前删除了导致 4xx 错误）
    newHeaders.set('Host', targetHost);

    // 只删除 Cloudflare 特有的头
    newHeaders.delete('cf-connecting-ip');
    newHeaders.delete('cf-ipcountry');
    newHeaders.delete('cf-ray');
    newHeaders.delete('cf-visitor');
    newHeaders.delete('x-forwarded-proto');
    newHeaders.delete('x-real-ip');

    // 5. 构造新请求
    const newRequest = new Request(url.toString(), {
      method: request.method,
      headers: newHeaders,
      // ✅ 修复2：GET 和 HEAD 请求不应该带 body
      body: request.method !== 'GET' && request.method !== 'HEAD'
        ? request.body
        : undefined,
      redirect: 'follow'
    });

    try {
      const response = await fetch(newRequest);
      
      // 6. 重新包装响应，注入 CORS 头 (否则客户端收不到数据)
      const newResponse = new Response(response.body, response);
      newResponse.headers.set('Access-Control-Allow-Origin', '*');
      
      return newResponse;
    } catch (e) {
      return new Response(JSON.stringify({ error: e.message }), { 
        status: 500,
        headers: corsHeaders
      });
    }
  }
};