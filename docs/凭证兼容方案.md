# 凭证兼容方案：基于时间点和Scopes的智能识别

## 问题背景

- **旧凭证**（11月26日前）：只有3个scopes，仅支持Gemini CLI API
- **新凭证**（11月26日后）：有5个scopes，同时支持Gemini CLI + Antigravity API

## 解决方案：智能识别 + 自动路由

### 方案A：基于Scopes判断（推荐）✅

检查凭证的scopes字段，判断其能力：

```python
def get_credential_capabilities(cred_info):
    """判断凭证支持的API类型"""
    scopes = cred_info.get('scopes', [])

    # 检查是否包含Antigravity所需的scopes
    has_cclog = 'https://www.googleapis.com/auth/cclog' in scopes
    has_experiments = 'https://www.googleapis.com/auth/experimentsandconfigs' in scopes

    capabilities = {
        'gemini_cli': True,  # 所有凭证都支持Gemini CLI
        'antigravity': has_cclog and has_experiments
    }

    return capabilities

# 使用示例
def route_request(model_name, credential):
    caps = get_credential_capabilities(credential)

    if model_name in ['gemini-3.0-flash', 'claude-3.5-sonnet']:
        # 需要Antigravity API
        if caps['antigravity']:
            return use_antigravity_api(credential)
        else:
            raise Exception(f"该凭证不支持 {model_name}，请重新授权获取完整权限")
    else:
        # 使用Gemini CLI API
        return use_gemini_cli_api(credential)
```

### 方案B：基于时间戳判断（备选）

```python
import datetime

ANTIGRAVITY_SUPPORT_CUTOFF = datetime.datetime(2025, 11, 26, 0, 0, 0)

def is_antigravity_capable(cred_info):
    """基于授权时间判断"""
    timestamp = cred_info.get('timestamp', 0)
    auth_time = datetime.datetime.fromtimestamp(timestamp)

    return auth_time >= ANTIGRAVITY_SUPPORT_CUTOFF
```

**缺点**：
- 如果用户在26日前授权，但我们在26日后修改了代码，这个凭证仍然不可用
- 不如直接检查scopes准确

### 推荐：混合方案

```python
def select_api_for_model(model_name, credential):
    """根据模型和凭证能力选择API"""

    # 1. 判断模型需要哪个API
    antigravity_models = [
        'gemini-2.0-flash-exp',
        'gemini-3.0-flash-preview',
        'gemini-3.0-pro-preview',
        'claude-3.5-sonnet',
        'claude-4.5-sonnet'
    ]

    needs_antigravity = any(m in model_name for m in antigravity_models)

    if not needs_antigravity:
        # Gemini 2.5系列，用Gemini CLI
        return 'gemini_cli'

    # 2. 检查凭证是否支持Antigravity
    scopes = credential.get('scopes', [])
    has_antigravity_scopes = (
        'https://www.googleapis.com/auth/cclog' in scopes and
        'https://www.googleapis.com/auth/experimentsandconfigs' in scopes
    )

    if has_antigravity_scopes:
        return 'antigravity'
    else:
        # 友好提示用户
        raise InsufficientPermissionsError(
            f"模型 {model_name} 需要额外权限才能使用。\n"
            f"请在控制面板重新授权以支持 Gemini 3.0 和 Claude 模型。\n"
            f"缺少的权限: cclog, experimentsandconfigs"
        )
```

## 实现步骤

### 1. 修改凭证加载逻辑

```python
# src/credential_manager.py

class CredentialInfo:
    def __init__(self, data):
        self.data = data
        self.scopes = data.get('scopes', [])
        self.capabilities = self._detect_capabilities()

    def _detect_capabilities(self):
        return {
            'gemini_cli': True,
            'antigravity': self._has_antigravity_scopes()
        }

    def _has_antigravity_scopes(self):
        required = [
            'https://www.googleapis.com/auth/cclog',
            'https://www.googleapis.com/auth/experimentsandconfigs'
        ]
        return all(scope in self.scopes for scope in required)

    def supports_model(self, model_name):
        """检查该凭证是否支持指定模型"""
        if model_name in ANTIGRAVITY_MODELS:
            return self.capabilities['antigravity']
        return self.capabilities['gemini_cli']
```

### 2. 路由逻辑集成

```python
# src/openai_routes.py

@router.post("/v1/chat/completions")
async def chat_completions(request: ChatCompletionRequest):
    # 获取可用凭证
    all_creds = await credential_manager.get_all_credentials()

    # 筛选支持该模型的凭证
    compatible_creds = [
        cred for cred in all_creds
        if cred.supports_model(request.model)
    ]

    if not compatible_creds:
        # 检查是否有凭证但权限不足
        if all_creds:
            raise HTTPException(
                status_code=403,
                detail={
                    "error": "insufficient_permissions",
                    "message": f"当前所有凭证都不支持模型 {request.model}",
                    "solution": "请在控制面板重新授权以获取完整权限"
                }
            )
        else:
            raise HTTPException(status_code=503, detail="No credentials available")

    # 轮换选择一个凭证
    selected_cred = credential_manager.rotate_select(compatible_creds)

    # 根据凭证能力选择API
    if selected_cred.capabilities['antigravity'] and request.model in ANTIGRAVITY_MODELS:
        return await handle_antigravity_request(request, selected_cred)
    else:
        return await handle_gemini_cli_request(request, selected_cred)
```

### 3. 前端提示优化

在控制面板的文件管理页面，显示凭证能力：

```html
<div class="cred-capabilities">
    <span class="badge badge-success">Gemini CLI ✓</span>

    <!-- 检查是否支持Antigravity -->
    <span class="badge badge-warning" v-if="!hasAntigravityScopes">
        Antigravity ✗ (需要重新授权)
    </span>
    <span class="badge badge-success" v-else>
        Antigravity ✓ (支持3.0/Claude)
    </span>
</div>
```

## 迁移策略

### 对现有用户

1. **不强制迁移** - 旧凭证继续用于Gemini 2.5系列
2. **提示升级** - 当用户请求3.0/Claude模型时，提示需要重新授权
3. **平滑过渡** - 允许新旧凭证混用

### 对新用户

1. 直接授权获取5个scopes
2. 一个凭证通吃所有模型

## 总结

**优势**：
- ✅ 向后兼容 - 旧凭证继续工作
- ✅ 平滑升级 - 用户按需重新授权
- ✅ 智能路由 - 自动选择合适的API
- ✅ 清晰提示 - 权限不足时给出明确指引

**实施时间线**：
- 11月26日前：旧凭证 + 新凭证混用
- 11月26日后：逐步引导用户升级到新凭证
- 长期：保持兼容，不强制迁移
